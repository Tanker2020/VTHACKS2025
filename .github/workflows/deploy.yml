name: CI/CD (GHCR + self-hosted deploy w/ rollback)

on:
  push:
    branches: [ main ]
    paths:
      - 'railsApp/**'
      - 'python/**'
      - 'deploy/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to deploy (prod | prev | <sha>)'
        required: true
        default: 'prod'

concurrency:
  group: deploy-main
  cancel-in-progress: true

env:
  RAILS_DIR: railsApp
  PY_DIR: python
  COMPOSE_DIR: deploy

jobs:
  build-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_ns: ${{ steps.compute.outputs.image_ns }}
    steps:
      - uses: actions/checkout@v4

      - name: Compute IMAGE_NS (lowercased)
        id: compute
        shell: bash
        run: |
          ns="ghcr.io/${GITHUB_REPOSITORY,,}"
          echo "IMAGE_NS=${ns}" >> $GITHUB_ENV
          echo "image_ns=${ns}" >> $GITHUB_OUTPUT

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build & push Rails (arm64)
      - name: Build & push Rails (arm64)
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --pull \
            --cache-from type=registry,ref=$IMAGE_NS/rails:buildcache \
            --cache-to   type=registry,ref=$IMAGE_NS/rails:buildcache,mode=max \
            -t $IMAGE_NS/rails:${{ github.sha }} \
            -f $RAILS_DIR/Dockerfile \
            $RAILS_DIR \
            --push

      # Build & push Python Agent (arm64)
      - name: Build & push Agent (arm64)
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --pull \
            --cache-from type=registry,ref=$IMAGE_NS/agent:buildcache \
            --cache-to   type=registry,ref=$IMAGE_NS/agent:buildcache,mode=max \
            -t $IMAGE_NS/agent:${{ github.sha }} \
            -f $PY_DIR/Dockerfile \
            $PY_DIR \
            --push

      # ----- Rollback rotation: keep last prod as prev -----
      - name: Rotate rails prod -> prev
        continue-on-error: true
        run: |
          docker pull $IMAGE_NS/rails:prod || exit 0
          docker tag  $IMAGE_NS/rails:prod $IMAGE_NS/rails:prev
          docker push $IMAGE_NS/rails:prev

      - name: Promote rails sha -> prod
        run: |
          docker pull $IMAGE_NS/rails:${{ github.sha }}
          docker tag  $IMAGE_NS/rails:${{ github.sha }} $IMAGE_NS/rails:prod
          docker push $IMAGE_NS/rails:prod

      - name: Rotate agent prod -> prev
        continue-on-error: true
        run: |
          docker pull $IMAGE_NS/agent:prod || exit 0
          docker tag  $IMAGE_NS/agent:prod $IMAGE_NS/agent:prev
          docker push $IMAGE_NS/agent:prev

      - name: Promote agent sha -> prod
        run: |
          docker pull $IMAGE_NS/agent:${{ github.sha }}
          docker tag  $IMAGE_NS/agent:${{ github.sha }} $IMAGE_NS/agent:prod
          docker push $IMAGE_NS/agent:prod
  deploy:
    needs: build-push
    runs-on: self-hosted
    permissions:
      contents: read
      packages: read
    env:
      TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || 'prod' }}
      IMAGE_NS: ${{ needs.build-push.outputs.image_ns }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR on VM
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

       # --- Rotate/prod-prev on the VM (arm64) ---
      - name: Pull current prod if exists (ignore errors)
        run: docker pull $IMAGE_NS/rails:prod || true

      - name: Promote rails sha -> prod (and rotate)
        run: |
          # pull the freshly built sha (arm64)
          docker pull $IMAGE_NS/rails:${TAG}
          # if prod exists, move it to prev
          if docker image inspect $IMAGE_NS/rails:prod > /dev/null 2>&1; then
            docker tag  $IMAGE_NS/rails:prod $IMAGE_NS/rails:prev
            docker push $IMAGE_NS/rails:prev || true
          fi
          # tag the new sha as prod and push
          docker tag  $IMAGE_NS/rails:${TAG} $IMAGE_NS/rails:prod
          docker push $IMAGE_NS/rails:prod

      - name: Pull current agent prod if exists (ignore errors)
        run: docker pull $IMAGE_NS/agent:prod || true

      - name: Promote agent sha -> prod (and rotate)
        run: |
          docker pull $IMAGE_NS/agent:${TAG}
          if docker image inspect $IMAGE_NS/agent:prod > /dev/null 2>&1; then
            docker tag  $IMAGE_NS/agent:prod $IMAGE_NS/agent:prev
            docker push $IMAGE_NS/agent:prev || true
          fi
          docker tag  $IMAGE_NS/agent:${TAG} $IMAGE_NS/agent:prod
          docker push $IMAGE_NS/agent:prod

      # --- Deploy with compose (use prod tag by default) ---
      - name: Pull images for compose (prod)
        working-directory: backend/deploy
        run: IMAGE_NS=${IMAGE_NS} TAG=prod docker compose pull

      - name: DB migrate (rails)
        working-directory: backend/deploy
        env:
          RAILS_ENV: production
        run: IMAGE_NS=${IMAGE_NS} TAG=prod docker compose run --rm rails bundle exec rake db:migrate

      - name: Up services
        working-directory: backend/deploy
        run: IMAGE_NS=${IMAGE_NS} TAG=prod docker compose up -d

      - name: Health check
        run: |
          curl -fsS http://127.0.0.1:3000/health || (docker ps; docker logs $(docker ps -q --filter name=_rails_ | head -1); exit 1)